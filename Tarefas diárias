blueprint:
  name: Tarefas Diárias
  description: >
    Incrementa um contador diário (input_number) no horário especificado. Quando
    atingir o número de dias configurado, ativa um input_boolean. Se o input_boolean
    for desligado manualmente, o contador volta a zero.

    Funciona de forma extremamente confiável, já que input_number permite operações
    diretas de soma e leitura precisa de estado.

  domain: automation
  input:
    boolean_alvo:
      name: Booleano da Tarefa
      description: Input_boolean que será ativado ao atingir o alvo e que reseta o contador quando desligado.
      selector:
        entity:
          domain: input_boolean

    contador:
      name: Contador da Tarefa
      description: Input_number que será incrementado diariamente.
      selector:
        entity:
          domain: input_number

    dias_alvo:
      name: Dias até Acionar
      description: Número de dias para ativar o booleano.
      default: 7
      selector:
        number:
          min: 1
          max: 60
          unit_of_measurement: dias
          mode: slider

    hora_ativacao:
      name: Hora de Verificação Diária
      description: Horário diário para incrementar o contador e verificar.
      default: "00:00:00"
      selector:
        time: {}

mode: single

trigger:
  - platform: time
    at: !input hora_ativacao
    id: incrementar
  - platform: state
    entity_id: !input boolean_alvo
    to: 'off'
    id: zerar

condition: []

action:
  - choose:
      - conditions:
          - condition: trigger
            id: incrementar
        sequence:
          - service: input_number.set_value
            target:
              entity_id: !input contador
            data:
              value: >-
                {{ (states[inputs.contador].state | float(0)) + 1 }}

          - condition: template
            value_template: >-
              {{ (states[inputs.contador].state | float(0)) >= (inputs.dias_alvo | float(0)) }}

          - service: input_boolean.turn_on
            target:
              entity_id: !input boolean_alvo

      - conditions:
          - condition: trigger
            id: zerar
        sequence:
          - service: input_number.set_value
            target:
              entity_id: !input contador
            data:
              value: 0
